{
  "updatedAt": "2026-02-05T16:37:32.062Z",
  "createdAt": "2026-02-05T14:43:11.364Z",
  "id": "QNO5N3elpdFlHHi9",
  "name": "Traitement automatique des factures PDF",
  "description": null,
  "active": false,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "minutes"
            }
          ]
        }
      },
      "id": "schedule-trigger",
      "name": "Every 5 minutes",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        240,
        304
      ]
    },
    {
      "parameters": {
        "postProcessAction": "markAsRead",
        "options": {
          "forceReconnect": 0
        }
      },
      "id": "email-imap",
      "name": "RÃ©cupÃ©rer emails avec PDF",
      "type": "n8n-nodes-base.emailReadImap",
      "typeVersion": 2.1,
      "position": [
        464,
        304
      ],
      "credentials": {
        "imap": {
          "name": "IMAP account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "has-attachments",
              "leftValue": "={{ $json.attachments }}",
              "rightValue": "",
              "operator": {
                "type": "array",
                "operation": "notEmpty"
              }
            },
            {
              "id": "has-pdf",
              "leftValue": "={{ $json.attachments.some(a => a.mimeType === 'application/pdf') }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "true"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "filter-pdf-emails",
      "name": "Filter: Has PDF attachment",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        688,
        304
      ]
    },
    {
      "parameters": {
        "fieldToSplitOut": "attachments",
        "options": {}
      },
      "id": "split-attachments",
      "name": "SÃ©parer les piÃ¨ces jointes",
      "type": "n8n-nodes-base.splitOut",
      "typeVersion": 1,
      "position": [
        912,
        304
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false
          },
          "conditions": [
            {
              "id": "is-pdf",
              "leftValue": "={{ $json.mimeType }}",
              "rightValue": "application/pdf",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ]
        },
        "options": {}
      },
      "id": "filter-only-pdf",
      "name": "Filter: PDF only",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1120,
        304
      ]
    },
    {
      "parameters": {
        "jsCode": "// Extract PDF text using pdf-parse\n// Note: pdf-parse needs to be installed in n8n\n\nconst items = $input.all();\nconst output = [];\n\nfor (const item of items) {\n  try {\n    // Get PDF data from attachment\n    const pdfData = item.json.data;\n    \n    // Convert base64 to buffer if needed\n    let pdfBuffer;\n    if (typeof pdfData === 'string') {\n      pdfBuffer = Buffer.from(pdfData, 'base64');\n    } else {\n      pdfBuffer = pdfData;\n    }\n    \n    // Parse PDF (using built-in n8n capabilities)\n    // If pdf-parse is available, use it\n    // Otherwise, use a fallback method\n    \n    let text = '';\n    \n    try {\n      // Try using pdf-parse if available\n      const pdfParse = require('pdf-parse');\n      const data = await pdfParse(pdfBuffer);\n      text = data.text;\n    } catch (parseError) {\n      // Fallback: Use HTTP Request to external PDF parser API\n      // Or return binary data for next node to handle\n      console.log('pdf-parse not available, using fallback');\n      text = 'PDF_BINARY_DATA';\n    }\n    \n    output.push({\n      json: {\n        ...item.json,\n        extractedText: text,\n        filename: item.json.filename || 'unknown.pdf',\n        extractedAt: new Date().toISOString()\n      }\n    });\n    \n  } catch (error) {\n    output.push({\n      json: {\n        ...item.json,\n        error: error.message,\n        extractedText: null\n      }\n    });\n  }\n}\n\nreturn output;"
      },
      "id": "extract-pdf-text",
      "name": "Extract PDF Text",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1344,
        304
      ]
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4o",
          "mode": "list",
          "cachedResultName": "GPT-4o"
        },
        "messages": {
          "values": [
            {
              "content": "Tu es un assistant spÃ©cialisÃ© dans l'extraction de donnÃ©es de factures.\n\nTon rÃ´le est d'extraire les informations suivantes Ã  partir du texte d'une facture :\n\n1. **fournisseur** : Le nom complet du fournisseur/Ã©metteur de la facture\n2. **montant** : Le montant total TTC en euros (nombre dÃ©cimal, ex: 1234.56)\n3. **tva** : Le montant de la TVA en euros (nombre dÃ©cimal)\n4. **date** : La date de la facture au format YYYY-MM-DD\n5. **iban** : L'IBAN du fournisseur pour le paiement (si prÃ©sent)\n6. **numeroFacture** : Le numÃ©ro de la facture (si prÃ©sent)\n\nRÃ¨gles importantes :\n- RÃ©ponds UNIQUEMENT en JSON valide\n- Utilise null si une information n'est pas disponible\n- Pour les montants, utilise des nombres (pas de symboles â‚¬)\n- Pour la date, utilise le format ISO (YYYY-MM-DD)\n- Pour l'IBAN, enlÃ¨ve tous les espaces\n\nFormat de rÃ©ponse attendu :\n{\n  \"fournisseur\": \"Nom du fournisseur\",\n  \"montant\": 1234.56,\n  \"tva\": 234.56,\n  \"date\": \"2026-02-05\",\n  \"iban\": \"FR7612345678901234567890123\",\n  \"numeroFacture\": \"FAC-2026-001\"\n}",
              "role": "system"
            },
            {
              "content": "=Voici le texte extrait de la facture PDF :\n\n{{ $json.extractedText }}\n\nExtrait les informations structurÃ©es en JSON."
            }
          ]
        },
        "jsonOutput": true,
        "options": {
          "maxTokens": 500,
          "temperature": 0.2
        }
      },
      "id": "openai-extraction",
      "name": "OpenAI: Extract Invoice Data",
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        1568,
        304
      ],
      "credentials": {
        "openAiApi": {
          "name": "OpenAI account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "fournisseur",
              "name": "fournisseur",
              "value": "={{ $json.message.content.fournisseur }}",
              "type": "string"
            },
            {
              "id": "montant",
              "name": "montant",
              "value": "={{ $json.message.content.montant }}",
              "type": "number"
            },
            {
              "id": "tva",
              "name": "tva",
              "value": "={{ $json.message.content.tva }}",
              "type": "number"
            },
            {
              "id": "date",
              "name": "date",
              "value": "={{ $json.message.content.date }}",
              "type": "string"
            },
            {
              "id": "iban",
              "name": "iban",
              "value": "={{ $json.message.content.iban }}",
              "type": "string"
            },
            {
              "id": "numeroFacture",
              "name": "numeroFacture",
              "value": "={{ $json.message.content.numeroFacture }}",
              "type": "string"
            },
            {
              "id": "pdfFilename",
              "name": "pdfFilename",
              "value": "={{ $('Extract PDF Text').item.json.filename }}",
              "type": "string"
            },
            {
              "id": "emailFrom",
              "name": "emailFrom",
              "value": "={{ $('RÃ©cupÃ©rer emails avec PDF').item.json.from }}",
              "type": "string"
            },
            {
              "id": "emailSubject",
              "name": "emailSubject",
              "value": "={{ $('RÃ©cupÃ©rer emails avec PDF').item.json.subject }}",
              "type": "string"
            },
            {
              "id": "processedAt",
              "name": "processedAt",
              "value": "={{ $now.toISO() }}",
              "type": "string"
            },
            {
              "id": "status",
              "name": "status",
              "value": "Ã€ valider",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "format-data",
      "name": "Format Data",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1840,
        304
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false
          },
          "conditions": [
            {
              "id": "has-fournisseur",
              "leftValue": "={{ $json.fournisseur }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "isNotEmpty"
              }
            },
            {
              "id": "has-montant",
              "leftValue": "={{ $json.montant }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "validate-data",
      "name": "Validate: Has required data",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        2032,
        304
      ]
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "YOUR_GOOGLE_SHEET_ID",
          "mode": "list"
        },
        "sheetName": {
          "__rl": true,
          "value": "Factures",
          "mode": "list"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Fournisseur": "={{ $json.fournisseur }}",
            "Montant TTC": "={{ $json.montant }}",
            "TVA": "={{ $json.tva }}",
            "Date": "={{ $json.date }}",
            "IBAN": "={{ $json.iban }}",
            "NumÃ©ro Facture": "={{ $json.numeroFacture }}",
            "PDF": "={{ $json.pdfFilename }}",
            "Email From": "={{ $json.emailFrom }}",
            "Email Subject": "={{ $json.emailSubject }}",
            "Statut": "={{ $json.status }}",
            "TraitÃ© le": "={{ $json.processedAt }}"
          }
        },
        "options": {}
      },
      "id": "google-sheets",
      "name": "Save to Google Sheets",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        2224,
        304
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "name": "Google Sheets account"
        }
      },
      "notes": "Alternative: Use Airtable node instead"
    },
    {
      "parameters": {
        "select": "channel",
        "channelId": {
          "__rl": true,
          "value": "comptabilite",
          "mode": "name"
        },
        "text": "=:receipt: **Nouvelle facture reÃ§ue et traitÃ©e**",
        "otherOptions": {
          "includeLinkToWorkflow": false
        }
      },
      "id": "slack-notification",
      "name": "Slack: Notification gÃ©nÃ©rale",
      "type": "n8n-nodes-base.slack",
      "typeVersion": 2.2,
      "position": [
        2448,
        304
      ],
      "webhookId": "0c2e9a62-8ce7-4744-8fa3-2963febe9afc"
    },
    {
      "parameters": {
        "conditions": {
          "options": {},
          "conditions": [
            {
              "id": "high-amount",
              "leftValue": "={{ $json.montant }}",
              "rightValue": 5000,
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            }
          ]
        },
        "options": {}
      },
      "id": "check-amount",
      "name": "Check: Montant > 5000â‚¬",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        2672,
        304
      ]
    },
    {
      "parameters": {
        "select": "user",
        "user": {
          "__rl": true,
          "value": "MANAGER_SLACK_ID",
          "mode": "id"
        },
        "text": "=:warning: **ALERTE: Facture importante nÃ©cessitant validation**",
        "otherOptions": {
          "includeLinkToWorkflow": false
        }
      },
      "id": "slack-alert-manager",
      "name": "Slack: Alerte Manager",
      "type": "n8n-nodes-base.slack",
      "typeVersion": 2.2,
      "position": [
        2880,
        208
      ],
      "webhookId": "cfee36b8-e341-48b2-8f83-f44859f8db16"
    },
    {
      "parameters": {
        "content": "## ðŸ“§ Ã‰TAPE 1: RÃ©cupÃ©ration des emails\n\nCe workflow surveille votre boÃ®te email via IMAP toutes les 5 minutes.\n\n**Configuration requise:**\n- Credentials IMAP (Gmail, Outlook, etc.)\n- Filtrage: Emails avec piÃ¨ces jointes PDF uniquement\n- Action: Marquer comme lu aprÃ¨s traitement\n\n**Personnalisation:**\n- Ajuster la frÃ©quence dans le Schedule Trigger\n- Filtrer par expÃ©diteur spÃ©cifique si besoin\n- Changer le dossier INBOX si nÃ©cessaire",
        "height": 440,
        "width": 480,
        "color": 6
      },
      "id": "note-step1",
      "name": "Note: Ã‰tape 1",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        240,
        80
      ]
    },
    {
      "parameters": {
        "content": "## ðŸ” Ã‰TAPE 2: Extraction du texte PDF\n\nExtraction du contenu textuel des fichiers PDF.\n\n**MÃ©thodes disponibles:**\n1. **pdf-parse** (recommandÃ©) - Library Node.js\n2. **API externe** - Si pdf-parse non disponible\n3. **OCR** - Pour les PDFs scannÃ©s\n\n**Notes:**\n- Le Code node tente d'utiliser pdf-parse\n- Fallback vers mÃ©thode alternative si Ã©chec\n- GÃ¨re les PDFs encodÃ©s en base64",
        "height": 380,
        "width": 460,
        "color": 5
      },
      "id": "note-step2",
      "name": "Note: Ã‰tape 2",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        1120,
        80
      ]
    },
    {
      "parameters": {
        "content": "## ðŸ¤– Ã‰TAPE 3: Extraction AI avec OpenAI\n\nUtilisation de GPT-4 pour extraire les donnÃ©es structurÃ©es.\n\n**DonnÃ©es extraites:**\n- Fournisseur\n- Montant TTC\n- TVA\n- Date\n- IBAN\n- NumÃ©ro de facture\n\n**Configuration:**\n- Model: GPT-4o (recommandÃ©)\n- Temperature: 0.2 (prÃ©cision maximale)\n- JSON Output: ActivÃ©\n\n**Prompt optimisÃ©** pour extraction prÃ©cise des factures franÃ§aises.",
        "height": 380,
        "width": 480,
        "color": 4
      },
      "id": "note-step3",
      "name": "Note: Ã‰tape 3",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        1568,
        80
      ]
    },
    {
      "parameters": {
        "content": "## ðŸ’¾ Ã‰TAPE 4: Enregistrement & Notifications\n\nSauvegarde dans Google Sheets et notifications Slack.\n\n**Google Sheets:**\n- Table \"Factures\" avec toutes les colonnes\n- Statut: \"Ã€ valider\" par dÃ©faut\n\n**Alternative Airtable:**\n- Remplacer le node Google Sheets\n- MÃªme structure de donnÃ©es\n\n**Slack:**\n- Notification #comptabilite pour toutes les factures\n- Alerte DM manager si montant > 5000â‚¬\n\n**Conditions d'alerte:**\n- Montant > 5000â‚¬\n- Message formatÃ© avec dÃ©tails complets",
        "height": 440,
        "width": 660,
        "color": 3
      },
      "id": "note-step4",
      "name": "Note: Ã‰tape 4",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        2224,
        80
      ]
    },
    {
      "parameters": {
        "content": "## âš ï¸ GESTION D'ERREURS\n\n**Cas d'Ã©chec possibles:**\n1. PDF non lisible â†’ Log error\n2. Extraction OpenAI Ã©choue â†’ Retry\n3. DonnÃ©es manquantes â†’ Filter out\n4. API Sheets/Slack down â†’ Queue\n\n**TODO:**\n- Ajouter Error Trigger node\n- ImplÃ©menter retry logic\n- Logger dans un sheet \"Errors\"\n- Notification d'Ã©chec",
        "height": 300,
        "width": 380,
        "color": 7
      },
      "id": "note-errors",
      "name": "Note: Erreurs",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        1120,
        480
      ]
    }
  ],
  "connections": {
    "Every 5 minutes": {
      "main": [
        [
          {
            "node": "RÃ©cupÃ©rer emails avec PDF",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "RÃ©cupÃ©rer emails avec PDF": {
      "main": [
        [
          {
            "node": "Filter: Has PDF attachment",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter: Has PDF attachment": {
      "main": [
        [
          {
            "node": "SÃ©parer les piÃ¨ces jointes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "SÃ©parer les piÃ¨ces jointes": {
      "main": [
        [
          {
            "node": "Filter: PDF only",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter: PDF only": {
      "main": [
        [
          {
            "node": "Extract PDF Text",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract PDF Text": {
      "main": [
        [
          {
            "node": "OpenAI: Extract Invoice Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI: Extract Invoice Data": {
      "main": [
        [
          {
            "node": "Format Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Data": {
      "main": [
        [
          {
            "node": "Validate: Has required data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validate: Has required data": {
      "main": [
        [
          {
            "node": "Save to Google Sheets",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save to Google Sheets": {
      "main": [
        [
          {
            "node": "Slack: Notification gÃ©nÃ©rale",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Slack: Notification gÃ©nÃ©rale": {
      "main": [
        [
          {
            "node": "Check: Montant > 5000â‚¬",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check: Montant > 5000â‚¬": {
      "main": [
        [
          {
            "node": "Slack: Alerte Manager",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "callerPolicy": "workflowsFromSameOwner",
    "availableInMCP": false
  },
  "pinData": {},
  "tags": []
}